@extends('layouts.estructura_base')

@section('title', 'Gestión de Equipos')

@section('content')
<style>
    .filter-option-item:hover {
        background-color: #e1effa !important;
        color: #0067b1 !important;
        cursor: pointer;
    }

    /* Selection Styles for Row */
    tr.selected-row-maquinaria {
        background-color: #e1effa !important;
        border-left: 4px solid #0067b1 !important;
        transition: all 0.2s ease;
    }
    
    tr.selected-row-maquinaria td {
        color: #0067b1 !important;
    }

    /* Floating Bar Style */
    .selection-floating-bar {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #1e293b;
        color: white;
        padding: 12px 25px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        opacity: 0;
    }

    .selection-floating-bar.active {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .selection-counter {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 14px;
    }

    .btn-bulk-action {
        background: #0067b1;
        color: white;
        border: none;
        padding: 8px 18px;
        border-radius: 25px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }

    .btn-bulk-action:hover {
        background: #005a9c;
        transform: scale(1.05);
    }
</style>
<section class="page-title-card" style="text-align: left; margin: 0 0 10px 0;">
    <h1 class="page-title">
        <span class="page-title-line2" style="color: #000;">Gestión de Equipos y Maquinaria</span>
    </h1>
</section>

<div class="page-layout-grid" style="display: grid; grid-template-columns: minmax(0, 1fr) 300px; gap: 40px; align-items: start; width: 100%;">
    
    <!-- Left Column: Table & Filters -->
    <div class="admin-card" style="margin: 0; min-height: 80vh; min-width: 0; width: 100%;">
    <div class="filter-toolbar-container" style="margin-bottom: 5px;">
        <!-- Frente Filter -->
        <div class="filter-item aligned-filter">
            <div class="custom-dropdown" id="frenteFilterSelect">
                <input type="hidden" name="id_frente" id="input_frente_filter" value="{{ request('id_frente') }}" form="search-form">
                
                @php 
                    $currentFrente = $frentes->firstWhere('ID_FRENTE', request('id_frente'));
                @endphp

                <div class="dropdown-trigger" style="padding: 0; display: flex; align-items: center; background: {{ request('id_frente') && request('id_frente') != 'all' ? '#e1effa' : '#fbfcfd' }}; overflow: hidden; border: 1px solid {{ request('id_frente') && request('id_frente') != 'all' ? '#0067b1' : '#cbd5e0' }}; border-radius: 12px; height: 45px;">
                    <div style="padding: 0 10px; display: flex; align-items: center; color: var(--maquinaria-gray-text);">
                        <i class="material-icons" style="font-size: 18px;">search</i>
                    </div>
                    <input type="text" id="filterSearchInput" 
                        placeholder="{{ $currentFrente ? $currentFrente->NOMBRE_FRENTE : 'Filtrar Frente...' }}" 
                        style="width: 100%; border: none; background: transparent; padding: 10px 5px; font-size: 14px; outline: none;"
                        onkeyup="filterDropdownOptions(this)"
                        autocomplete="off">
                    <i id="btn_clear_frente" class="material-icons" style="padding: 0 5px; cursor: pointer; color: var(--maquinaria-gray-text); font-size: 18px; display: {{ request('id_frente') && request('id_frente') != 'all' ? 'block' : 'none' }};" onclick="event.stopPropagation(); clearFilter('id_frente');">close</i>
                    <i class="material-icons" style="padding: 0 10px; cursor: pointer; color: var(--maquinaria-gray-text);">expand_more</i>
                </div>

                <div class="dropdown-content" style="padding: 5px; max-height: none; overflow: visible;">
                    <div class="dropdown-item-list" id="frenteItemsList" style="max-height: 250px; overflow-y: auto;">
                            <div class="dropdown-item {{ !request('id_frente') || request('id_frente') == 'all' ? 'selected' : '' }}" onclick="selectOption('frenteFilterSelect', 'all', 'Todos los Frentes', 'frente_filter');">
                                Todos los Frentes
                            </div>
                            @foreach($frentes as $frente)
                                <div class="dropdown-item {{ request('id_frente') == $frente->ID_FRENTE ? 'selected' : '' }}" onclick="selectOption('frenteFilterSelect', '{{ $frente->ID_FRENTE }}', '{{ $frente->NOMBRE_FRENTE }}', 'frente_filter');">
                                    {{ $frente->NOMBRE_FRENTE }}
                                </div>
                            @endforeach
                    </div>
                </div>
            </div>
        </div>

        <!-- Tipo Filter -->
        <div class="filter-item aligned-filter" style="flex: 1.5;">
            <div class="custom-dropdown" id="tipoFilterSelect">
                <input type="hidden" name="id_tipo" id="input_tipo_filter" value="{{ request('id_tipo') }}" form="search-form">
                
                @php 
                    $currentTipo = $allTipos->firstWhere('id', request('id_tipo'));
                @endphp

                <div class="dropdown-trigger" style="padding: 0; display: flex; align-items: center; background: {{ request('id_tipo') ? '#e1effa' : '#fbfcfd' }}; overflow: hidden; border: 1px solid {{ request('id_tipo') ? '#0067b1' : '#cbd5e0' }}; border-radius: 12px; height: 45px;">
                    <div style="padding: 0 10px; display: flex; align-items: center; color: var(--maquinaria-gray-text);">
                        <i class="material-icons" style="font-size: 18px;">search</i>
                    </div>
                    <input type="text" id="filterTipoSearchInput" 
                        placeholder="{{ $currentTipo ? $currentTipo->nombre : 'Filtrar Tipo...' }}" 
                        style="width: 100%; border: none; background: transparent; padding: 10px 5px; font-size: 14px; outline: none;"
                        onkeyup="filterDropdownOptions(this)"
                        autocomplete="off">
                    <i id="btn_clear_tipo" class="material-icons" style="padding: 0 5px; cursor: pointer; color: var(--maquinaria-gray-text); font-size: 18px; display: {{ request('id_tipo') ? 'block' : 'none' }};;" onclick="event.stopPropagation(); clearFilter('id_tipo');">close</i>
                    <i class="material-icons" style="padding: 0 10px; cursor: pointer; color: var(--maquinaria-gray-text);">expand_more</i>
                </div>

                <div class="dropdown-content" style="padding: 5px; max-height: none; overflow: visible;">
                    <div class="dropdown-item-list" id="tipoItemsList" style="max-height: 250px; overflow-y: auto;">
                        @foreach($allTipos as $tipo)
                            <div class="dropdown-item {{ request('id_tipo') == $tipo->id ? 'selected' : '' }}" onclick="selectOption('tipoFilterSelect', '{{ $tipo->id }}', '{{ $tipo->nombre }}', 'tipo_filter');">
                                {{ $tipo->nombre }}
                            </div>
                        @endforeach
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Filter / Seriales -->
        <!-- Search Filter / Seriales + Advanced Filter Button -->
        <div class="filter-item aligned-filter" style="display: flex; gap: 10px;">
            <form action="{{ route('equipos.index') }}" method="GET" id="search-form" onsubmit="event.preventDefault(); loadEquipos();" style="flex: 1; margin: 0;">
                
                <div class="search-wrapper" style="width: 100%; border-color: {{ request('search_query') ? '#0067b1' : '#cbd5e0' }}; background: {{ request('search_query') ? '#e1effa' : '#fff' }};">
                    <i class="material-icons search-icon">search</i>
                    <input type="text" id="searchInput" name="search_query" value="{{ request('search_query') }}" 
                        placeholder="Buscar Código y Seriales" 
                        class="search-input-field"
                        autocomplete="off"
                        onkeyup="if(this.value.length >= 4 || this.value.length == 0) { /* Debounce handled in script */ }">
                    <i id="btn_clear_search" class="material-icons clear-icon" style="display: {{ request('search_query') ? 'block' : 'none' }};" onclick="clearFilter('search_query');">close</i>
                </div>
            </form>

            <!-- Advanced Filter Trigger -->
            <div style="position: relative;">
                <button type="button" id="btnAdvancedFilter" class="btn-primary-maquinaria" style="height: 45px; width: 45px; padding: 0; display: flex; align-items: center; justify-content: center; background: {{ request('modelo') || request('anio') ? '#e1effa' : 'white' }}; border: 1px solid {{ request('modelo') || request('anio') ? '#0067b1' : '#cbd5e0' }}; color: {{ request('modelo') || request('anio') ? '#0067b1' : '#64748b' }}; box-shadow: none;">
                    <i class="material-icons">filter_list</i>
                </button>
                
                <!-- Dynamic Filter Panel -->
                <div id="advancedFilterPanel" style="display: none; position: absolute; top: 100%; right: 0; width: 300px; background: #e2e8f0; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); border: 1px solid #cbd5e1; z-index: 100; margin-top: 10px; padding: 15px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px; font-weight: 700; color: #334155; display: flex; justify-content: space-between; align-items: center;">
                        Filtros Avanzados
                        <span style="font-size: 11px; color: #64748b; font-weight: 400; cursor: pointer; text-decoration: underline;" onclick="clearAdvancedFilters()">Limpiar Todo</span>
                    </h4>

                    <!-- Model Filter (Collapsible Autocomplete) -->
                    <div style="margin-bottom: 15px;">
                        <label for="searchModelInput" style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px;">Modelo</label>
                        <div style="position: relative;">
                            <div style="position: relative; margin-bottom: 5px;">
                                <i class="material-icons" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #94a3b8;">search</i>
                                <input type="text" id="searchModelInput" 
                                    placeholder="{{ request('modelo') ?: 'Buscar modelo...' }}" 
                                    value="{{ request('modelo') }}"
                                    onkeyup="filterList('searchModelInput', 'modelList'); document.getElementById('modelList').style.display='block'; document.getElementById('btn_clear_modelo').style.display = this.value ? 'block' : 'none';" 
                                    onfocus="document.getElementById('modelList').style.display='block'"
                                    onblur="setTimeout(() => document.getElementById('modelList').style.display='none', 200)"
                                    style="width: 100%; padding: 6px 30px 6px 30px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; outline: none; box-sizing: border-box;"
                                    autocomplete="off">
                                <i id="btn_clear_modelo" class="material-icons" 
                                   style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #94a3b8; cursor: pointer; display: {{ request('modelo') ? 'block' : 'none' }}; z-index: 5;"
                                   onclick="event.preventDefault(); event.stopPropagation(); selectAdvancedFilter('modelo', ''); document.getElementById('searchModelInput').value = '';">close</i>
                            </div>
                            <div id="modelList" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 150px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 6px; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">

                                @if(isset($availableModelos))
                                    @foreach($availableModelos as $mod)
                                        <div class="filter-option-item {{ request('modelo') == $mod ? 'selected' : '' }}" data-advanced-filter="true" data-key="modelo" data-value="{{ $mod }}">{{ $mod }}</div>
                                    @endforeach
                                @endif
                            </div>
                        </div>
                    </div>

                    <!-- Year Filter (Collapsible Dropdown) -->
                    <div>
                        <span id="yearLabel" style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 5px;">Año</span>
                        <div style="position: relative;">
                            <div class="dropdown-trigger" tabindex="0" 
                                 onclick="const l = document.getElementById('yearList'); l.style.display = l.style.display === 'none' ? 'block' : 'none';"
                                 onblur="setTimeout(() => document.getElementById('yearList').style.display='none', 200)"
                                 style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 6px 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; bg: white;">
                                <span>{{ request('anio') ?: 'Seleccionar Año' }}</span>
                                <div style="display: flex; align-items: center;">
                                    <i id="btn_clear_anio" class="material-icons" 
                                       style="font-size: 16px; color: #94a3b8; cursor: pointer; margin-right: 5px; display: {{ request('anio') ? 'block' : 'none' }};"
                                       onclick="event.stopPropagation(); selectAdvancedFilter('anio', '');">close</i>
                                    <i class="material-icons" style="font-size: 16px; color: #94a3b8;">expand_more</i>
                                </div>
                            </div>
                            <div id="yearList" aria-labelledby="yearLabel" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; max-height: 120px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 6px; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">

                                @if(isset($availableAnios))
                                    @foreach($availableAnios as $anio)
                                        <div class="filter-option-item {{ request('anio') == $anio ? 'selected' : '' }}" data-advanced-filter="true" data-key="anio" data-value="{{ $anio }}">{{ $anio }}</div>
                                    @endforeach
                                @endif
                            </div>
                        </div>
                    </div>

                    <!-- Documentation Filters (New) -->
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #cbd5e1;">
                        <span style="display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 8px;">Documentación Cargada</span>
                        
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #334155;">
                                <input type="checkbox" id="chk_propiedad" onchange="toggleDocFilter('propiedad')" {{ request('filter_propiedad') == 'true' ? 'checked' : '' }} style="margin-right: 8px; accent-color: #0067b1;">
                                Propiedad
                            </label>

                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #334155;">
                                <input type="checkbox" id="chk_poliza" onchange="toggleDocFilter('poliza')" {{ request('filter_poliza') == 'true' ? 'checked' : '' }} style="margin-right: 8px; accent-color: #0067b1;">
                                Póliza
                            </label>

                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #334155;">
                                <input type="checkbox" id="chk_rotc" onchange="toggleDocFilter('rotc')" {{ request('filter_rotc') == 'true' ? 'checked' : '' }} style="margin-right: 8px; accent-color: #0067b1;">
                                ROTC
                            </label>

                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px; color: #334155;">
                                <input type="checkbox" id="chk_racda" onchange="toggleDocFilter('racda')" {{ request('filter_racda') == 'true' ? 'checked' : '' }} style="margin-right: 8px; accent-color: #0067b1;">
                                RACDA
                            </label>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- New Button -->
        <!-- Dropdown Menu Button (Acciones: Nuevo, Exportar, Movilización) -->
        <div class="filter-item aligned-filter" style="position: relative; width: auto; flex: 0 0 auto; margin-left: auto;">
            
            <!-- Main Trigger Button -->
            <button type="button" id="btnAcciones" class="btn-primary-maquinaria" style="padding: 0 15px; height: 45px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <i class="material-icons">settings</i>
                <span>Acciones</span>
                <i class="material-icons" style="font-size: 18px; margin-left: 2px;">expand_more</i>
            </button>

            <!-- Dropdown Menu -->
            <div id="splitDropdownMenu" style="display: none; position: absolute; top: 100%; right: 0; width: 220px; background: #e2e8f0; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; z-index: 50; margin-top: 5px; overflow: hidden; animation: slideDown 0.2s ease-out;">
                
                <!-- Movilización -->
                <a href="{{ route('movilizaciones.index') }}" class="dropdown-item-custom" style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #475569; text-decoration: none; transition: all 0.2s; border-bottom: 1px solid #f1f5f9;">
                    <div style="background: #f0fdf4; padding: 6px; border-radius: 6px; display: flex;">
                        <i class="material-icons" style="font-size: 18px; color: #16a34a;">local_shipping</i>
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">Movilización</span>
                </a>

                <!-- Exportar -->
                <a href="#" onclick="exportEquipos(); return false;" class="dropdown-item-custom" style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #475569; text-decoration: none; transition: all 0.2s; border-bottom: 1px solid #f1f5f9;">
                    <div style="background: #f1f5f9; padding: 6px; border-radius: 6px; display: flex;">
                        <i class="material-icons" style="font-size: 18px; color: #64748b;">download</i>
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">Exportación de Data</span>
                </a>

                <!-- Nuevo -->
                <a href="{{ route('equipos.create') }}" class="dropdown-item-custom" style="display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #475569; text-decoration: none; transition: all 0.2s;">
                    <div style="background: #e0f2fe; padding: 6px; border-radius: 6px; display: flex;">
                        <i class="material-icons" style="font-size: 18px; color: #0284c7;">add_circle</i>
                    </div>
                    <span style="font-size: 14px; font-weight: 500;">Nuevo Equipo</span>
                </a>
            </div>
        </div>

        <!-- Hidden Input for Year Filter -->
        <input type="hidden" name="anio" id="input_anio_filter" value="{{ request('anio') }}">

        <!-- Advanced Filter Logic migrated to equipos_index.js -->
    </div>
    <div class="custom-scrollbar-container" style="margin-top: 5px;">
        <table class="admin-table" style="width: 100%; min-width: 850px;">
            <thead>
                <tr class="table-row-header">
                    <th class="table-header-custom" style="width: 160px;"></th> <!-- Foto -->
                    <th class="table-header-custom" style="width: 170px;">Tipo</th>
                    <th class="table-header-custom" style="width: 95px;">Marca / Modelo</th>
                    <th class="table-header-custom" style="width: 160px;">Serials / Placa / ID</th>
                    <th class="table-header-custom" style="width: 95px;">Estatus</th>
                    <th class="table-cell-center" style="width: 20px; padding: 10px 5px;"></th>
                </tr>
            </thead>
            <tbody id="equiposTableBody" style="font-size: 15px;">
                @include('admin.equipos.partials.table_rows')

            </tbody>
        </table>
        
        <form id="delete-form-global" action="" method="POST" style="display: none;">
            @csrf
            @method('DELETE')
        </form>
    </div>

    <!-- Improved Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px; padding: 0; border-radius: 16px; overflow: hidden; background: #f8fafc;">
            <!-- Modal Header -->
            <div style="background: var(--maquinaria-dark-blue); padding: 20px 25px; color: white; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div>
                        <h2 id="modal_equipo_title" style="margin: 0; font-size: 20px; font-weight: 700;">Detalles del Equipo</h2>
                        <p id="modal_equipo_subtitle" style="margin: 5px 0 0 0; opacity: 0.8; font-size: 13px;"></p>
                    </div>
                    <a id="modal_gps_btn" href="#" target="_blank" style="display: none; background: #10b981; color: white; padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; text-decoration: none; align-items: center; gap: 6px; transition: 0.2s; margin-right: 20px;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <i class="material-icons" style="font-size: 18px;">gps_fixed</i>
                        GPS
                    </a>
                </div>
                <button type="button" onclick="closeDetailsModal(event)" style="background: rgba(255,255,255,0.1); border: none; color: white; cursor: default; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <i class="material-icons">close</i>
                </button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 25px; max-height: 80vh; overflow-y: auto;">

                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px;">
                    <button id="tab_btn_general" onclick="switchModalTab('general')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: #64748b; cursor: default; transition: all 0.2s; outline: none; font-size: 14px;" class="modal-tab-active">
                        <i class="material-icons" style="font-size: 18px; vertical-align: text-bottom; margin-right: 5px;">info</i>
                        General
                    </button>
                    <button id="tab_btn_specs" onclick="switchModalTab('specs')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: #64748b; cursor: default; transition: all 0.2s; outline: none; font-size: 14px;">
                        <i class="material-icons" style="font-size: 18px; vertical-align: text-bottom; margin-right: 5px;">settings_applications</i>
                        Especificaciones
                    </button>
                    <button id="tab_btn_legal" onclick="switchModalTab('legal')" style="flex: 1; padding: 12px; background: none; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: #64748b; cursor: default; transition: all 0.2s; outline: none; font-size: 14px;">
                        <i class="material-icons" style="font-size: 18px; vertical-align: text-bottom; margin-right: 5px;">description</i>
                        Legal
                    </button>
                </div>

                <!-- Tab 1: General Info -->
                <div id="tab_content_general" style="display: block;">
                     <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; max-width: 600px; margin: 0 auto;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--maquinaria-blue); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px;">
                            <i class="material-icons" style="font-size: 20px;">info</i> Información General
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 15px; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                <span style="color: #64748b;">Año de Fabricación:</span>
                                <strong id="d_anio" style="color: #1e293b;"></strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                <span style="color: #64748b;">Categoría de Flota:</span>
                                <strong id="d_categoria" style="color: #1e293b;"></strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;">
                                <span style="color: #64748b;">Serial de Motor:</span>
                                <strong id="d_motor_serial" style="color: #1e293b;"></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Specs -->
                <div id="tab_content_specs" style="display: none;">
                    <div style="background: white; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--maquinaria-blue); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px;">
                            <i class="material-icons" style="font-size: 20px;">settings_applications</i> Ficha Técnica Detallada
                        </h3>
                        <div style="font-size: 13px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            
                            <!-- Col 1 -->
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Mecánica -->
                                <div>
                                    <strong style="display: block; color: #94a3b8; font-size: 11px; text-transform: uppercase; margin-bottom: 5px;">Mecánica</strong>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="background: #f8fafc; padding: 8px; border-radius: 6px;">
                                            <span style="display:block; color:#64748b; font-size: 10px;">Motor</span>
                                            <strong id="d_motor_tech" style="color:#334155;"></strong>
                                        </div>
                                        <div style="background: #f8fafc; padding: 8px; border-radius: 6px;">
                                            <span style="display:block; color:#64748b; font-size: 10px;">Capacidad</span>
                                            <strong id="d_capacidad" style="color:#334155;"></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 2 -->
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <!-- Combustible -->
                                <div>
                                    <strong style="display: block; color: #94a3b8; font-size: 11px; text-transform: uppercase; margin-bottom: 5px;">Combustible & Sistema</strong>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="background: #f8fafc; padding: 6px; border-radius: 4px;">
                                            <span style="display:block; color:#64748b; font-size: 10px;">Tipo</span>
                                            <strong id="d_combustible" style="color:#334155;"></strong>
                                        </div>
                                        <div style="background: #f8fafc; padding: 6px; border-radius: 4px;">
                                            <span style="display:block; color:#64748b; font-size: 10px;">Consumo</span>
                                            <strong id="d_consumo" style="color:#334155;"></strong>
                                        </div>
                                    </div>
                                </div>

                                 <!-- Fluidos y Otros -->
                                <div>
                                    <strong style="display: block; color: #94a3b8; font-size: 11px; text-transform: uppercase; margin-bottom: 5px;">Mantenimiento</strong>
                                    <div style="display: grid; grid-template-columns: 1fr; gap: 5px;">
                                        <div style="display:flex; justify-content:space-between; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2px;"><span style="color:#64748b;">Aceite Motor:</span> <strong id="d_aceite_m"></strong></div>
                                        <div style="display:flex; justify-content:space-between; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2px;"><span style="color:#64748b;">Aceite Caja:</span> <strong id="d_aceite_c"></strong></div>
                                        <div style="display:flex; justify-content:space-between; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2px;"><span style="color:#64748b;">Liga Freno:</span> <strong id="d_liga"></strong></div>
                                        <div style="display:flex; justify-content:space-between; border-bottom: 1px dashed #e2e8f0; padding-bottom: 2px;"><span style="color:#64748b;">Refrigerante:</span> <strong id="d_refrigerante"></strong></div>
                                        <div style="display:flex; justify-content:space-between;"><span style="color:#64748b;">Batería:</span> <strong id="d_bateria"></strong></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Tab 3: Legal Info -->
                <div id="tab_content_legal" style="display: none;">
                    <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; max-width: 600px; margin: 0 auto;">
                        <h3 style="margin: 0 0 20px 0; font-size: 16px; color: #059669; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                            <i class="material-icons" style="font-size: 22px;">description</i> Documentación Legal y Soportes
                        </h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px; font-size: 14px;">
                            
                            <div style="display: grid; grid-template-columns: 150px 1fr; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Titular del Registro</span>
                                <strong id="d_titular" style="color: #1e293b; font-size: 14px;"></strong>
                            </div>

                            <!-- Placa -->
                            <div style="display: grid; grid-template-columns: 150px 1fr; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Placa Identificadora</span>
                                <strong id="d_placa" style="color: var(--maquinaria-blue); font-size: 15px; letter-spacing: 0.5px;"></strong>
                            </div>

                            <!-- Documento Propiedad (With Button) -->
                            <div style="display: grid; grid-template-columns: 150px 1fr auto; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Nro. Documento</span>
                                <strong id="d_nro_doc" style="color: #1e293b;"></strong>
                                <div id="d_btn_propiedad"></div>
                            </div>

                            <!-- Seguro -->
                            <div style="display: grid; grid-template-columns: 150px 1fr auto; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Póliza de Seguro</span>
                                <div>
                                    <strong id="d_seguro" style="display: block; color: #1e293b;"></strong>
                                    <small id="d_venc_seguro" style="color: #ef4444; font-weight: 600;"></small>
                                </div>
                                <div id="d_btn_poliza"></div>
                            </div>

                            <!-- ROTC -->
                            <div style="display: grid; grid-template-columns: 150px 1fr auto; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Registro ROTC</span>
                                <strong id="d_fecha_rotc" style="color: #1e293b;"></strong>
                                <div id="d_btn_rotc"></div>
                            </div>

                            <!-- RACDA -->
                            <div style="display: grid; grid-template-columns: 150px 1fr auto; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9;">
                                <span style="color: #64748b; font-weight: 500;">Registro RACDA</span>
                                <strong id="d_fecha_racda" style="color: #1e293b;"></strong>
                                <div id="d_btn_racda"></div>
                            </div>

                        </div>
                    </div>
            </div>

        </div>
    </div>
</div>

    <!-- Pagination removed as requested (Single list on filter) -->
    <div id="equiposPagination" style="margin-top: 25px;"></div>
</div> <!-- End admin-card -->

<!-- Right Column: Simple Counter -->
<div class="counter-sidebar" style="position: sticky; top: 20px; display: flex; flex-direction: column; gap: 15px;">
    @php $hasFilter = request('search_query') || request('id_frente') || request('id_tipo'); @endphp
    
    <!-- Main Total Card -->
    <div style="background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%); border-radius: 12px; padding: 15px; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
        <!-- Decorative Icon -->
        <i class="material-icons" style="position: absolute; right: -15px; bottom: -15px; font-size: 80px; opacity: 0.1; transform: rotate(-15deg);">agriculture</i>
        
        <div style="position: relative; z-index: 2;">
            <div style="font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; opacity: 0.8; margin-bottom: 12px; display: flex; align-items: center; gap: 6px;">
                <i class="material-icons" style="font-size: 14px;">pie_chart</i>
                Consolidado de Equipos
            </div>
            
            <div style="display: flex; align-items: center; gap: 8px;">
                <!-- Main Total -->
                <div style="display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.15); padding: 8px 6px; border-radius: 10px; min-width: 65px;">
                    <span id="stats_total" style="font-size: 36px; font-weight: 800; line-height: 1;">
                        {{ $hasFilter ? $stats['total'] : '--' }}
                    </span>
                    <span style="font-size: 13px; opacity: 0.8; font-weight: 700; margin-top: 2px;">TOTAL</span>
                </div>
                
                <!-- Detailed Stats Row -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; flex: 1;">
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.15); padding: 6px 2px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.25);">
                        <i class="material-icons" style="font-size: 20px; color: #ef4444; margin-bottom: 2px;">cancel</i>
                        <strong id="stats_inactivos" style="font-weight: 800; font-size: 20px;">{{ $hasFilter ? $stats['inactivos'] : '--' }}</strong>
                        <span style="font-size: 11px; opacity: 0.8; font-weight: 700; text-transform: uppercase;">Inoperativos</span>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(245, 158, 11, 0.15); padding: 6px 2px; border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.25);">
                        <i class="material-icons" style="font-size: 20px; color: #f59e0b; margin-bottom: 2px;">engineering</i>
                        <strong id="stats_mantenimiento" style="font-weight: 800; font-size: 20px;">{{ $hasFilter ? $stats['mantenimiento'] : '--' }}</strong>
                        <span style="font-size: 11px; opacity: 0.8; font-weight: 700;">MANTENIMIENTO</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breakdown by Type or Front (Dynamic) -->
    <div style="background: white; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden;">
        <div id="distributionStatsContainer">
            @include('admin.equipos.partials.distribution_stats')
        </div>
    </div>
</div>

</div> <!-- End Page Layout Grid -->


<!-- Loading Overlay -->
<div id="exportLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 10000; flex-direction: column; justify-content: center; align-items: center;">
    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
    <div style="margin-top: 15px; font-weight: 600; color: #334155;">Preparando archivo excel...</div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
    document.addEventListener('click', function(e) {
        if(e.target.closest('#btnExportar')) {
            e.preventDefault();
            exportData();
        }
    });

    function exportData() {
        const loader = document.getElementById('exportLoader');
        loader.style.display = 'flex';

        // Get current params
        const params = new URLSearchParams(window.location.search);
        const url = "{{ route('equipos.export') }}?" + params.toString();

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Error en la descarga');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Generate filename (optional, server header usually handles it but we can force it)
                a.download = 'equipos_export_' + new Date().toISOString().slice(0,10) + '.xls'; 
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                alert('Hubo un error al exportar los datos. Por favor intente de nuevo.');
                console.error('Export Error:', error);
            })
            .finally(() => {
                loader.style.display = 'none';
            });
    }
</script>

<!-- Image Overlay Modal -->
<div id="imageOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; cursor: default;" onclick="this.style.display='none'">
    <img id="enlargedImg" style="max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); transition: transform 0.3s ease;">
</div>

<!-- Floating Action Bar -->
<div id="bulkFloatingBar" class="selection-floating-bar">
    <div class="selection-counter">
        <div style="background: rgba(255,255,255,0.1); padding: 5px; border-radius: 50%; display: flex;">
            <i class="material-icons" style="font-size: 18px; color: #60a5fa;">inventory_2</i>
        </div>
        <span id="bulkCountText">0 equipos seleccionados</span>
    </div>
    <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.2);"></div>
    <div style="display: flex; gap: 10px;">
        <button type="button" onclick="clearSelection(event)" style="background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 13px; font-weight: 600;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#94a3b8'">
            Limpiar
        </button>
        <button type="button" onclick="openBulkModal(event)" class="btn-bulk-action">
            <i class="material-icons" style="font-size: 18px;">local_shipping</i>
            Movilizar
        </button>
    </div>
</div>

<!-- Hidden Datalist for Dynamic Modal (Autocomplete Source) -->
<datalist id="frentesList" style="display: none;">
    @foreach($frentes as $f)
        <option value="{{ $f->NOMBRE_FRENTE }}" data-id="{{ $f->ID_FRENTE }}"></option>
    @endforeach
</datalist>

@endsection
@section('extra_js')
    {{-- Replaced by Global Load in Layout --}}
@endsection
